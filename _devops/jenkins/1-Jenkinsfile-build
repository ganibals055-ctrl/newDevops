pipeline {
    agent any
    
    environment {
        SHARED_WS = '/var/jenkins_home/workspace/doggo_nexus'
        IMAGE_RANDOM = "doggo-random-service"
        IMAGE_RATING = "doggo-rating-service"
        VERSION = "latest"
    }

    stages {
        stage('Checkout') {
            steps {
                dir(env.SHARED_WS) {
                    checkout scm
                }
            }
        }

        stage('Build Docker images') {
            steps {
                dir(env.SHARED_WS) {
                    sh """
                        echo "=== Собираем Java сервис ==="
                        docker build -t ${IMAGE_RANDOM}:${VERSION} DogRandomService
                        
                        echo "=== Собираем .NET сервис ==="
                        docker build -t ${IMAGE_RATING}:${VERSION} DogRatingService
                        
                        echo "=== Готовые образы ==="
                        docker images | grep -E "${IMAGE_RANDOM}|${IMAGE_RATING}"
                    """
                }
            }
        }

        stage('Load images to Minikube') {
            steps {
                sh """
                    echo "=== Загружаем образы в Minikube ==="
                    minikube image load ${IMAGE_RANDOM}:${VERSION}
                    minikube image load ${IMAGE_RATING}:${VERSION}
                    
                    echo "=== Проверяем в Minikube ==="
                    minikube image list | grep -E "${IMAGE_RANDOM}|${IMAGE_RATING}"
                """
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                dir(env.SHARED_WS) {
                    sh """
                        echo "=== Деплой в Minikube ==="
                        
                        # Применяем все манифесты
                        kubectl apply -f _devops/k8s/
                        
                        echo "=== Ждем запуска (30 секунд) ==="
                        sleep 30
                        
                        echo "=== Проверяем pods ==="
                        kubectl get pods
                        
                        echo "=== Проверяем services ==="
                        kubectl get services
                    """
                }
            }
        }

        stage('Test application') {
            steps {
                sh """
                    echo "=== Тестируем приложение ==="
                    
                    # Получаем URL сервиса
                    MINIKUBE_IP=\$(minikube ip)
                    
                    echo "Java сервис: http://\${MINIKUBE_IP}:30000"
                    echo ".NET сервис: http://\${MINIKUBE_IP}:30001"
                    
                    # Тестируем Java сервис
                    echo "Тест Java сервиса:"
                    curl -s http://\${MINIKUBE_IP}:30000/actuator/health || echo "Java сервис не отвечает"
                    
                    # Тестируем .NET сервис
                    echo "Тест .NET сервиса:"
                    curl -s http://\${MINIKUBE_IP}:30001/health || echo ".NET сервис не отвечает"
                """
            }
        }
    }

    post {
        always {
            echo "=== Очистка ==="
            cleanWs()
        }
        
        success {
            echo "✅ ✅ ✅ ВСЕ ГОТОВО! ✅ ✅ ✅"
            echo "1. Приложение работает!"
            echo "2. Jenkins pipeline выполнен!"
            echo "3. Без Nexus (но он у вас есть в docker-compose)"
            echo ""
            echo "Откройте в браузере:"
            echo "- Java сервис: http://\$(minikube ip):30000"
            echo "- .NET сервис: http://\$(minikube ip):30001"
        }
        
        failure {
            echo "❌ Что-то пошло не так"
            echo "Для очистки: kubectl delete -f _devops/k8s/"
        }
    }
}