pipeline {
    agent any
    
    environment {
        SHARED_WS = '/var/jenkins_home/workspace/doggo_nexus'
        IMAGE_RANDOM = "doggo-random-service"
        IMAGE_RATING = "doggo-rating-service"
        VERSION = "latest"
    }

    stages {
        stage('Checkout') {
            steps {
                dir(env.SHARED_WS) {
                    checkout scm
                }
            }
        }

        stage('Build Docker images') {
            steps {
                dir(env.SHARED_WS) {
                    sh """
                        echo "=== Собираем Docker образы ==="
                        docker build -t ${IMAGE_RANDOM}:${VERSION} DogRandomService
                        docker build -t ${IMAGE_RATING}:${VERSION} DogRatingService
                    """
                }
            }
        }

        stage('Prepare K8s manifests') {
            steps {
                dir(env.SHARED_WS) {
                    sh """
                        echo "=== Подготавливаем манифесты ==="
                        
                        # Создаем временные файлы с правильными именами образов
                        cp _devops/k8s/doggo-deployment.yaml _devops/k8s/doggo-deployment-temp.yaml
                        cp _devops/k8s/doggo-rating-deployment.yaml _devops/k8s/doggo-rating-deployment-temp.yaml
                        
                        # Заменяем плейсхолдеры на реальные имена образов
                        sed -i 's|image-doggo-replace|${IMAGE_RANDOM}:${VERSION}|g' _devops/k8s/doggo-deployment-temp.yaml
                        sed -i 's|image-rating-replace|${IMAGE_RATING}:${VERSION}|g' _devops/k8s/doggo-rating-deployment-temp.yaml
                    """
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                dir(env.SHARED_WS) {
                    sh """
                        echo "=== Деплой в Kubernetes ==="
                        
                        # Применяем базовые конфиги
                        kubectl apply -f _devops/k8s/configmap.yaml
                        kubectl apply -f _devops/k8s/secret.yaml
                        kubectl apply -f _devops/k8s/postgres.yaml
                        
                        echo "Ждем запуска PostgreSQL (15 секунд)..."
                        sleep 15
                        
                        # Применяем основные сервисы
                        kubectl apply -f _devops/k8s/doggo-deployment-temp.yaml
                        kubectl apply -f _devops/k8s/doggo-rating-deployment-temp.yaml
                        
                        echo "=== Проверяем deployment ==="
                        kubectl get deployments
                        kubectl get pods
                        kubectl get services
                    """
                }
            }
        }

        stage('Wait for pods') {
            steps {
                sh """
                    echo "=== Ждем пока поды запустятся ==="
                    
                    # Ждем максимум 60 секунд
                    timeout 60 bash -c '
                        while true; do
                            READY=\$(kubectl get pods -o jsonpath="{.items[*].status.conditions[?(@.type==\"Ready\")].status}" | grep -c "True")
                            TOTAL=\$(kubectl get pods -o jsonpath="{.items[*].metadata.name}" | wc -w)
                            if [ "\$READY" -eq "\$TOTAL" ] && [ "\$TOTAL" -gt 0 ]; then
                                echo "✓ Все \$TOTAL pod\'ов запущены"
                                break
                            fi
                            echo "Готово: \$READY/\$TOTAL"
                            sleep 5
                        done
                    '
                """
            }
        }

        stage('Test application') {
            steps {
                sh """
                    echo "=== Тестируем приложение ==="
                    
                    # Получаем NodePortы
                    JAVA_PORT=\$(kubectl get service doggo -o jsonpath='{.spec.ports[0].nodePort}')
                    DOTNET_PORT=\$(kubectl get service doggo-rating -o jsonpath='{.spec.ports[0].nodePort}')
                    
                    # Получаем IP Minikube через kubectl
                    MINIKUBE_IP=\$(kubectl get node -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
                    
                    echo "Java сервис: http://\${MINIKUBE_IP}:\${JAVA_PORT}"
                    echo ".NET сервис: http://\${MINIKUBE_IP}:\${DOTNET_PORT}"
                    
                    echo "Тест Java сервиса (health):"
                    curl -f -m 10 http://\${MINIKUBE_IP}:\${JAVA_PORT}/actuator/health && echo "✓ Java сервис работает" || echo "✗ Java сервис не отвечает"
                    
                    echo "Тест .NET сервиса (health):"
                    curl -f -m 10 http://\${MINIKUBE_IP}:\${DOTNET_PORT}/health && echo "✓ .NET сервис работает" || echo "✗ .NET сервис не отвечает"
                """
            }
        }
    }

    post {
        always {
            echo "=== Очистка ==="
            sh """
                # Удаляем временные файлы
                rm -f _devops/k8s/*-temp.yaml 2>/dev/null || true
            """
            cleanWs()
        }
        
        success {
            echo "✅ ✅ ✅ ВСЕ ГОТОВО! ✅ ✅ ✅"
            echo "Приложение развернуто в Kubernetes!"
            
            sh """
                echo "=== Итоговая информация ==="
                echo "Pods:"
                kubectl get pods
                echo ""
                echo "Services:"
                kubectl get services
                echo ""
                echo "Для доступа:"
                echo "Java:  http://\$(kubectl get node -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}'):\$(kubectl get service doggo -o jsonpath='{.spec.ports[0].nodePort}')"
                echo ".NET: http://\$(kubectl get node -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}'):\$(kubectl get service doggo-rating -o jsonpath='{.spec.ports[0].nodePort}')"
            """
        }
        
        failure {
            echo "❌ Pipeline завершился с ошибкой"
            echo "Для очистки выполните:"
            echo "  kubectl delete -f _devops/k8s/ --ignore-not-found=true"
            echo "  kubectl delete pvc postgres-data --ignore-not-found=true"
        }
    }
}